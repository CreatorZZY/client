<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gingko Writer Database Download</title>
  <script src="https://unpkg.com/dexie"></script>
  <script src="https://unpkg.com/dexie-export-import"></script>
</head>
<body>
<h1>Your download should begin automatically...</h1>
<ol id="info"></ol>
<script>
  function addInfo (infoText) {
    let li = document.createElement('li');
    li.innerText = infoText;
    document.getElementById('info').appendChild(li)
  }

  async function downloadDb () {
    const dbs = await indexedDB.databases();
    addInfo('Databases list: ' + dbs.map(x => { if (x.hasOwnProperty('name')) return x.name; }));
    const dbName = dbs[0].name;
    addInfo('Downloading from ' + dbName);

    let db = new Dexie(dbName);
    addInfo('Dexie loaded.');
    const { verno, tables } = await db.open();
    addInfo('Database opened...');
    db.close();

    db = new Dexie(dbName);
    db.version(verno).stores(tables.reduce((p,c) => {
      p[c.name] = c.schema.primKey.keyPath || "";
      return p;
    }, {}));

    addInfo('Starting database export. THIS MAY TAKE A WHILE! ...');
    const blob = await db.export({
      numRowsPerChunk: 2
    });
    addInfo('Database export complete... starting download...');

    var a = document.createElement("a");
    document.body.appendChild(a);
    url = window.URL.createObjectURL(blob);
    a.href = url;
    a.download = "gingko-writer-db-export.json";
    a.click();
    window.URL.revokeObjectURL(url);

    addInfo('Download should be complete. Look for "gingko-writer-db-export.json" in you file system');
  };

  downloadDb();
</script>

</body>
</html>